<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { background: #1b2838; color: #c6d4df; font-family: sans-serif; text-align: center; padding: 30px; }
        .box { background: #2a475e; padding: 25px; border-radius: 8px; border: 1px solid #3d6b91; }
        input { width: 85%; padding: 12px; margin: 15px 0; background: #171a21; color: #fff; border: 1px solid #3d6b91; border-radius: 4px; font-size: 18px; }
        button { background: #67c1f5; color: white; border: none; padding: 12px; width: 90%; cursor: pointer; font-weight: bold; border-radius: 4px; }
        #log { margin-top: 20px; font-size: 12px; color: #8f98a0; text-align: left; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="box">
        <h3>Steam å…¨åº“åŠ©æ‰‹</h3>
        <input type="text" id="appid" placeholder="è¾“å…¥æ¸¸æˆ AppID">
        <button onclick="caiSearch()">åŒæ­¥è”¡å·¥å…·æºå¹¶å…¥åº“</button>
        <div id="log">å‡†å¤‡å°±ç»ª</div>
    </div>

    <script>
        async function caiSearch() {
            const id = document.getElementById('appid').value.trim();
            const log = document.getElementById('log');
            if(!id) return;

            log.innerText = "â³ æ­£åœ¨åŒæ­¥å…¨çƒæ•°æ®ä»“åº“...\n";
            // è”¡å·¥å…·æ ¸å¿ƒï¼šå–å‰ä¸¤ä½åšåˆ†ç‰‡
            const p = id.length > 2 ? id.substring(0, 2) : "0";
            
            // ç›´æ¥æ¬è¿è”¡å·¥å…·æºç ä¸­çš„ 10 ä¸ªæºï¼ˆç²¾ç®€ä¸ºæœ€ç¨³çš„ 4 ä¸ªï¼‰
            const urls = [
                {n: "ä¸»åŠ›æ•´åˆåº“", u: `https://cdn.jsdmirror.com/gh/pvzcxw/cai-install_stloader@main/data.json`, isAgg: true},
                {n: "Github-SAC", u: `https://cdn.jsdmirror.com/gh/SteamAutoCracks/ManifestHub@main/data/${p}/${id}.json`},
                {n: "Github-SWA", u: `https://cdn.jsdmirror.com/gh/SteamManifestArchives/ManifestHub@main/data/${p}/${id}.json`},
                {n: "Github-Auiowu", u: `https://cdn.jsdmirror.com/gh/Auiowu/ManifestAutoUpdate@master/manifests/${id}.json`}
            ];

            let result = null;
            for (let s of urls) {
                log.innerText += `ğŸ” æ­£åœ¨æ’åº“: ${s.n}...\n`;
                try {
                    const res = await fetch(s.u);
                    if (res.ok) {
                        const json = await res.json();
                        const data = s.isAgg ? json[id] : json;
                        if (data) {
                            result = parse(data);
                            break;
                        }
                    }
                } catch (e) {}
            }

            if (result && result.length > 0) {
                const info = await pywebview.api.sync_to_steam(JSON.stringify(result));
                log.innerText = info;
            } else {
                log.innerText = "âŒ è”¡å·¥å…·çš„æ‰€æœ‰æºé‡Œéƒ½æ²¡è¿™ä¸ª IDï¼Œå»ºè®®ç¡®è®¤ ID æ˜¯å¦æ­£ç¡®ã€‚";
            }
        }

        // è”¡å·¥å…·ä¸‡èƒ½è§£æé€»è¾‘
        function parse(d) {
            let list = [];
            if (d.depots) {
                list = d.depots.map(x => ({did: x.depot_id, mid: x.manifest_id, key: x.key || ""}));
            } else {
                for (let k in d) {
                    if (d[k].manifest || d[k].manifest_id) {
                        list.push({did: k, mid: d[k].manifest || d[k].manifest_id, key: d[k].key || ""});
                    }
                }
            }
            return list;
        }
    </script>
</body>
</html>
